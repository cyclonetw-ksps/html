<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²æ–‡æœ—è®€å­¸ç¿’ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Microsoft JhengHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ç›®éŒ„èˆ‡èª²æ–‡é¸æ“‡ç•«é¢ */
        #selectionScreen {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .selection-header {
            text-align: center;
            margin-bottom: 30px;
            color: #5a67d8;
        }

        .selection-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .selection-container {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }

        .panel {
            background: #f7fafc;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e2e8f0;
        }

        .panel-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            margin: -20px -20px 20px -20px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }

        .directory-list, .lesson-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .directory-item, .lesson-item {
            padding: 12px;
            margin: 5px 0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            font-size: 16px;
        }

        .directory-item:hover, .lesson-item:hover {
            background: #e6fffa;
            border-color: #4fd1c5;
        }

        .directory-item.selected, .lesson-item.selected {
            background: #bee3f8;
            border-color: #5a67d8;
            font-weight: bold;
        }

        .directory-item.new-tag::after {
            content: "(new)";
            color: #ef4444;
            font-size: 12px;
            margin-left: 5px;
        }

        .lesson-count {
            font-size: 12px;
            color: #718096;
            float: right;
        }

        /* æ‰‹å‹•ä¸Šå‚³å€ */
        .manual-upload {
            margin-top: 20px;
            padding: 15px;
            background: #fef5e7;
            border-radius: 8px;
            border: 2px dashed #f39c12;
        }

        .manual-upload h3 {
            color: #e67e22;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .file-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .file-input-wrapper input[type="file"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: white;
        }

        .upload-button {
            padding: 8px 20px;
            background: #f39c12;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .upload-button:hover {
            background: #e67e22;
        }

        /* ä¸»è¦å­¸ç¿’ä»‹é¢ */
        #mainInterface {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .control-button {
            padding: 10px 20px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .control-button.active {
            background: #5a67d8;
            color: white;
        }

        .play-button {
            background: #48bb78;
            color: white;
            font-size: 18px;
            padding: 12px 30px;
        }

        .play-button:hover {
            background: #38a169;
        }

        .play-button.playing {
            background: #e53e3e;
        }

        /* æ–‡å­—ç¶²æ ¼ */
        .text-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            min-height: 500px;
        }

        .text-cell {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            padding: 5px;
        }

        .text-cell:hover {
            background: #fef5e7;
            border-color: #f39c12;
            transform: scale(1.05);
        }

        .text-cell.playing {
            background: #d5f4e6;
            border-color: #27ae60;
            animation: pulse 0.5s;
        }

        .text-cell.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .text-cell.empty:hover {
            background: transparent;
            border: none;
            transform: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .main-char {
            font-size: 32px;
            font-weight: bold;
            color: #2c3e50;
            line-height: 1;
        }

        .zhuyin {
            font-size: 14px;
            color: #e74c3c;
            margin-top: 5px;
            font-family: 'æ¨™æ¥·é«”', 'DFKai-sb', serif;
        }

        /* åˆ†é æ§åˆ¶ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
        }

        .page-button {
            padding: 8px 16px;
            background: #5a67d8;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .page-button:hover:not(:disabled) {
            background: #4c51bf;
        }

        .page-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }

        .page-info {
            font-size: 16px;
            font-weight: bold;
            color: #4a5568;
        }

        /* è¿”å›æŒ‰éˆ• */
        .back-button {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: white;
            border: 2px solid #5a67d8;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            color: #5a67d8;
            font-weight: bold;
            z-index: 1000;
        }

        .back-button:hover {
            background: #5a67d8;
            color: white;
        }

        /* è¼‰å…¥æç¤º */
        .loading-message {
            text-align: center;
            padding: 20px;
            color: #718096;
        }

        .error-message {
            background: #fee2e2;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }

        /* ç‹€æ…‹è¨Šæ¯ */
        .status-message {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #48bb78;
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            font-weight: bold;
            display: none;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .lesson-title {
            background: #ebf8ff;
            color: #2c5282;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- è¿”å›æŒ‰éˆ• -->
    <button class="back-button" onclick="backToSelection()" style="display: none;">â† è¿”å›é¸æ“‡</button>

    <!-- ç›®éŒ„èˆ‡èª²æ–‡é¸æ“‡ç•«é¢ -->
    <div id="selectionScreen">
        <div class="selection-header">
            <h1>ğŸ“š èª²æ–‡æœ—è®€å­¸ç¿’ç³»çµ±</h1>
            <p>è«‹é¸æ“‡å¹´ç´šç‰ˆæœ¬èˆ‡èª²æ–‡</p>
        </div>

        <div class="selection-container">
            <div class="panel">
                <div class="panel-header">ç›®éŒ„é¸æ“‡</div>
                <div class="directory-list" id="directoryList">
                    <div class="loading-message">è¼‰å…¥ä¸­...</div>
                </div>

                <!-- æ‰‹å‹•ä¸Šå‚³ -->
                <div class="manual-upload">
                    <h3>ğŸ“‚ æ‰‹å‹•ä¸Šå‚³èª²æ–‡</h3>
                    <div class="file-input-wrapper">
                        <input type="file" id="manualFileInput" accept=".txt" multiple>
                        <button class="upload-button" onclick="uploadManualFiles()">ä¸Šå‚³</button>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">èª²æ–‡é¸æ“‡</div>
                <div class="lesson-list" id="lessonList">
                    <div style="text-align: center; color: #718096; padding: 20px;">
                        è«‹å…ˆé¸æ“‡å·¦å´çš„ç›®éŒ„
                    </div>
                </div>
                <button class="control-button play-button" style="width: 100%; margin-top: 20px;" onclick="startLesson()" id="startButton" disabled>
                    é–‹å§‹å­¸ç¿’
                </button>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å­¸ç¿’ä»‹é¢ -->
    <div id="mainInterface">
        <div class="lesson-title" id="lessonTitle">è¼‰å…¥ä¸­...</div>
        
        <div class="control-panel">
            <div class="control-group">
                <span style="color: white; font-weight: bold;">é¡¯ç¤ºæ¨¡å¼ï¼š</span>
                <button class="control-button" onclick="setDisplayMode('char')">åœ‹å­—</button>
                <button class="control-button active" onclick="setDisplayMode('both')">åœ‹å­—+æ³¨éŸ³</button>
                <button class="control-button" onclick="setDisplayMode('zhuyin')">ç´”æ³¨éŸ³</button>
            </div>
            <div class="control-group">
                <button class="control-button play-button" id="playAllBtn" onclick="playAll()">
                    ğŸ”Š å…¨æ–‡å¿µè®€
                </button>
                <button class="control-button" style="background: #ff6b6b; color: white; display: none;" onclick="stopPlaying()" id="stopBtn">
                    â¹ åœæ­¢
                </button>
            </div>
            <div class="control-group">
                <span style="color: white; font-weight: bold;">å­—å‹ï¼š</span>
                <select id="fontSelector" class="control-button" onchange="changeFont()">
                    <option value="'æ¨™æ¥·é«”', 'DFKai-sb', serif">æ¨™æ¥·é«”</option>
                    <option value="'å¾®è»Ÿæ­£é»‘é«”', 'Microsoft JhengHei', sans-serif">å¾®è»Ÿæ­£é»‘é«”</option>
                    <option value="'æ–°ç´°æ˜é«”', 'PMingLiU', serif">æ–°ç´°æ˜é«”</option>
                    <option value="'æ¥·é«”', 'KaiTi', serif">æ¥·é«”</option>
                </select>
            </div>
        </div>

        <div class="text-grid" id="textGrid"></div>

        <div class="pagination">
            <button class="page-button" onclick="previousPage()">ä¸Šä¸€é </button>
            <span class="page-info" id="pageInfo">ç¬¬ 1 é  / å…± 1 é </span>
            <button class="page-button" onclick="nextPage()">ä¸‹ä¸€é </button>
        </div>
    </div>

    <!-- ç‹€æ…‹è¨Šæ¯ -->
    <div class="status-message" id="statusMessage"></div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentData = [];
        let currentPage = 0;
        let totalPages = 1;
        let displayMode = 'both';
        let isPlaying = false;
        let soundBasePath = 'sounddata/';
        let playingAudio = null;
        let currentFont = "'æ¨™æ¥·é«”', 'DFKai-sb', serif";
        let selectedDirectory = '';
        let selectedLesson = '';
        let lessonData = {};

        // DATA è³‡æ–™å¤¾çš„é è¨­è³‡æ–™çµæ§‹
        const dataIndex = {
            "è¼¸æ—åœ‹èªä¸€ä¸Š": [
                "ç¬¬ä¸€èª².txt", "ç¬¬äºŒèª².txt", "ç¬¬ä¸‰èª².txt", "ç¬¬å››èª².txt",
                "ç¬¬äº”èª².txt", "ç¬¬å…­èª².txt", "ç¬¬ä¸ƒèª².txt", "ç¬¬å…«èª².txt"
            ],
            "è¼¸æ—åœ‹èªä¸€ä¸‹(èˆŠ)": [
                "ç¬¬ä¸€èª².txt", "ç¬¬äºŒèª².txt", "ç¬¬ä¸‰èª².txt", "ç¬¬å››èª².txt"
            ],
            "è¼¸æ—åœ‹èªä¸€ä¸‹": [
                "ç¬¬ä¸€èª².txt", "ç¬¬äºŒèª².txt", "ç¬¬ä¸‰èª².txt", "ç¬¬å››èª².txt"
            ],
            "è¼¸æ—åœ‹èªä¸‰ä¸‹": [
                "ç¬¬ä¸€èª².txt", "ç¬¬äºŒèª².txt", "ç¬¬ä¸‰èª².txt", "ç¬¬å››èª².txt"
            ],
            "è¼¸æ—åœ‹èªäºŒä¸Š": [
                "ç¬¬ä¹èª².txt", "ç¬¬åèª².txt", "ç¬¬åä¸€èª².txt", "ç¬¬åäºŒèª².txt"
            ],
            "è¼¸æ—åœ‹èªäºŒä¸‹(new)": [
                "ç¬¬ä¹èª².txt", "ç¬¬åèª².txt", "ç¬¬åä¸€èª².txt", "ç¬¬åäºŒèª².txt"
            ],
            "è¼¸æ—åœ‹èªäºŒä¸‹": [
                "ç¬¬åä¸‰èª².txt", "ç¬¬åå››èª².txt", "ç¬¬åäº”èª².txt", "ç¬¬åå…­èª².txt"
            ],
            "è¼¸æ—åœ‹èªäº”ä¸Š": [
                "ç¬¬ä¸€èª².txt", "ç¬¬äºŒèª².txt", "ç¬¬ä¸‰èª².txt", "ç¬¬å››èª².txt"
            ]
        };

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('=== èª²æ–‡æœ—è®€ç³»çµ±åˆå§‹åŒ– ===');
            await loadDataDirectory();
        });

        // è¼‰å…¥ DATA ç›®éŒ„
        async function loadDataDirectory() {
            const directoryList = document.getElementById('directoryList');
            
            try {
                // é¦–å…ˆå˜—è©¦è¼‰å…¥ data-index.jsonï¼ˆç”¨æ–¼ GitHubï¼‰
                const response = await fetch('data-index.json');
                let availableData = dataIndex;
                
                if (response.ok) {
                    console.log('æ‰¾åˆ° data-index.jsonï¼Œä½¿ç”¨ç·šä¸Šè³‡æ–™');
                    availableData = await response.json();
                } else {
                    console.log('ä½¿ç”¨é è¨­è³‡æ–™çµæ§‹');
                }
                
                // æ¸…ç©ºè¼‰å…¥æç¤º
                directoryList.innerHTML = '';
                
                // é¡¯ç¤ºç›®éŒ„åˆ—è¡¨
                Object.keys(availableData).forEach(dir => {
                    const item = document.createElement('div');
                    item.className = 'directory-item';
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰ (new) æ¨™ç±¤
                    if (dir.includes('(new)')) {
                        item.classList.add('new-tag');
                    }
                    
                    // é¡¯ç¤ºç›®éŒ„åç¨±å’Œèª²æ–‡æ•¸é‡
                    const lessonCount = availableData[dir].length;
                    item.innerHTML = `
                        ${dir}
                        <span class="lesson-count">${lessonCount} èª²</span>
                    `;
                    
                    item.onclick = () => selectDirectory(dir, availableData[dir]);
                    directoryList.appendChild(item);
                });
                
                lessonData = availableData;
                
            } catch (error) {
                console.error('è¼‰å…¥ç›®éŒ„å¤±æ•—:', error);
                directoryList.innerHTML = '<div class="error-message">ç„¡æ³•è¼‰å…¥èª²æ–‡ç›®éŒ„ï¼Œè«‹æª¢æŸ¥ DATA è³‡æ–™å¤¾</div>';
            }
        }

        // é¸æ“‡ç›®éŒ„
        function selectDirectory(dir, lessons) {
            selectedDirectory = dir;
            
            // æ›´æ–°é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.directory-item').forEach(item => {
                item.classList.remove('selected');
                if (item.textContent.includes(dir)) {
                    item.classList.add('selected');
                }
            });
            
            // é¡¯ç¤ºèª²æ–‡åˆ—è¡¨
            const lessonList = document.getElementById('lessonList');
            lessonList.innerHTML = '';
            
            lessons.forEach(lesson => {
                const item = document.createElement('div');
                item.className = 'lesson-item';
                // ç§»é™¤ .txt å‰¯æª”åé¡¯ç¤º
                const lessonName = lesson.replace('.txt', '');
                item.textContent = lessonName;
                item.onclick = () => selectLesson(lessonName, lesson);
                lessonList.appendChild(item);
            });
            
            showStatus(`å·²é¸æ“‡ï¼š${dir}`);
        }

        // é¸æ“‡èª²æ–‡
        async function selectLesson(lessonName, fileName) {
            selectedLesson = lessonName;
            
            // æ›´æ–°é¸ä¸­ç‹€æ…‹
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.classList.remove('selected');
                if (item.textContent === lessonName) {
                    item.classList.add('selected');
                }
            });
            
            // å•Ÿç”¨é–‹å§‹æŒ‰éˆ•
            document.getElementById('startButton').disabled = false;
            
            // å˜—è©¦è¼‰å…¥èª²æ–‡å…§å®¹
            try {
                const filePath = `DATA/${selectedDirectory}/${fileName}`;
                console.log('å˜—è©¦è¼‰å…¥:', filePath);
                
                const response = await fetch(filePath);
                if (response.ok) {
                    const content = await response.text();
                    currentData = parseText(content);
                    showStatus(`å·²è¼‰å…¥ï¼š${lessonName}`);
                } else {
                    console.warn('ç„¡æ³•è‡ªå‹•è¼‰å…¥èª²æ–‡ï¼Œéœ€è¦æ‰‹å‹•é¸æ“‡æª”æ¡ˆ');
                    showStatus('è«‹é»æ“Šã€Œé–‹å§‹å­¸ç¿’ã€å¾Œæ‰‹å‹•é¸æ“‡æª”æ¡ˆ');
                }
            } catch (error) {
                console.log('è‡ªå‹•è¼‰å…¥å¤±æ•—ï¼Œå°‡åœ¨é–‹å§‹å­¸ç¿’æ™‚æç¤ºæ‰‹å‹•é¸æ“‡');
            }
        }

        // æ‰‹å‹•ä¸Šå‚³æª”æ¡ˆ
        function uploadManualFiles() {
            const fileInput = document.getElementById('manualFileInput');
            if (fileInput.files.length === 0) {
                alert('è«‹é¸æ“‡è‡³å°‘ä¸€å€‹æª”æ¡ˆ');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                const content = e.target.result;
                currentData = parseText(content);
                
                selectedDirectory = 'æ‰‹å‹•ä¸Šå‚³';
                selectedLesson = file.name.replace('.txt', '');
                
                // ç›´æ¥é–‹å§‹å­¸ç¿’
                startLesson();
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // é–‹å§‹å­¸ç¿’
        function startLesson() {
            if (currentData.length === 0) {
                // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œæç¤ºæ‰‹å‹•é¸æ“‡æª”æ¡ˆ
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.txt';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        currentData = parseText(content);
                        showMainInterface();
                    };
                    reader.readAsText(file, 'UTF-8');
                };
                input.click();
            } else {
                showMainInterface();
            }
        }

        // é¡¯ç¤ºä¸»ä»‹é¢
        function showMainInterface() {
            document.getElementById('selectionScreen').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
            document.querySelector('.back-button').style.display = 'block';
            
            // é¡¯ç¤ºèª²æ–‡æ¨™é¡Œ
            document.getElementById('lessonTitle').textContent = 
                `${selectedDirectory} - ${selectedLesson}`;
            
            renderPage();
        }

        // è§£æèª²æ–‡ï¼ˆä¿ç•™æ›è¡Œï¼‰
        function parseText(text) {
            const result = [];
            const lines = text.split('\n');
            
            lines.forEach((line, lineIndex) => {
                if (line.trim() === '') {
                    // ç©ºè¡Œï¼Œæ·»åŠ æ›è¡Œæ¨™è¨˜
                    result.push({
                        char: '\n',
                        zhuyin: '',
                        isNewline: true
                    });
                } else {
                    // è§£æé€™ä¸€è¡Œçš„æ–‡å­—
                    const charPattern = /(.)\(([^)]+)\)/g;
                    let lastIndex = 0;
                    let match;
                    
                    while ((match = charPattern.exec(line)) !== null) {
                        // è™•ç†åŒ¹é…å‰çš„æ¨™é»ç¬¦è™Ÿ
                        const beforeText = line.substring(lastIndex, match.index);
                        for (let char of beforeText) {
                            if (char && char !== ' ') {
                                result.push({
                                    char: char,
                                    zhuyin: char,
                                    isPunctuation: true
                                });
                            }
                        }
                        
                        // æ·»åŠ åŒ¹é…çš„å­—å’Œæ³¨éŸ³
                        result.push({
                            char: match[1],
                            zhuyin: match[2]
                        });
                        
                        lastIndex = charPattern.lastIndex;
                    }
                    
                    // è™•ç†è¡Œå°¾å‰©é¤˜çš„æ¨™é»ç¬¦è™Ÿ
                    const remainingText = line.substring(lastIndex);
                    for (let char of remainingText) {
                        if (char && char !== ' ') {
                            result.push({
                                char: char,
                                zhuyin: char,
                                isPunctuation: true
                            });
                        }
                    }
                    
                    // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€è¡Œï¼Œæ·»åŠ æ›è¡Œ
                    if (lineIndex < lines.length - 1) {
                        result.push({
                            char: '\n',
                            zhuyin: '',
                            isNewline: true
                        });
                    }
                }
            });
            
            return result;
        }

        // æ¸²æŸ“é é¢
        function renderPage() {
            const grid = document.getElementById('textGrid');
            grid.innerHTML = '';
            
            const itemsPerPage = 70;
            let displayData = [];
            let cellCount = 0;
            let pageData = [];
            
            // è™•ç†åˆ†é ï¼ˆè€ƒæ…®æ›è¡Œï¼‰
            for (let i = 0; i < currentData.length; i++) {
                if (currentData[i].isNewline) {
                    // æ›è¡Œï¼šå¡«æ»¿ç•¶å‰è¡Œ
                    const remainder = cellCount % 10;
                    if (remainder !== 0) {
                        const fillCount = 10 - remainder;
                        for (let j = 0; j < fillCount; j++) {
                            pageData.push({ isEmpty: true });
                            cellCount++;
                        }
                    }
                } else {
                    pageData.push(currentData[i]);
                    cellCount++;
                }
                
                // æª¢æŸ¥æ˜¯å¦éœ€è¦æ›é 
                if (cellCount >= itemsPerPage && i < currentData.length - 1) {
                    displayData.push(pageData);
                    pageData = [];
                    cellCount = 0;
                }
            }
            
            // æ·»åŠ æœ€å¾Œä¸€é 
            if (pageData.length > 0) {
                displayData.push(pageData);
            }
            
            totalPages = displayData.length || 1;
            
            // é¡¯ç¤ºç•¶å‰é 
            if (currentPage >= totalPages) {
                currentPage = 0;
            }
            
            const currentPageData = displayData[currentPage] || [];
            
            currentPageData.forEach((item, index) => {
                const cell = document.createElement('div');
                
                if (item.isEmpty) {
                    cell.className = 'text-cell empty';
                } else {
                    cell.className = 'text-cell';
                    cell.onclick = async () => {
                        if (!isPlaying) {
                            await playSound(item.zhuyin, cell);
                        }
                    };
                    
                    if (displayMode === 'char' || displayMode === 'both') {
                        const charDiv = document.createElement('div');
                        charDiv.className = 'main-char';
                        charDiv.textContent = item.char;
                        charDiv.style.fontFamily = currentFont;
                        cell.appendChild(charDiv);
                    }
                    
                    if (displayMode === 'zhuyin' || displayMode === 'both') {
                        const zhuyinDiv = document.createElement('div');
                        zhuyinDiv.className = 'zhuyin';
                        zhuyinDiv.textContent = item.zhuyin;
                        cell.appendChild(zhuyinDiv);
                    }
                }
                
                grid.appendChild(cell);
            });
            
            // è£œé½Šå‰©é¤˜ç©ºæ ¼åˆ°70å€‹
            const remainingCells = itemsPerPage - currentPageData.length;
            for (let i = 0; i < remainingCells; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'text-cell empty';
                grid.appendChild(emptyCell);
            }
            
            updatePageInfo();
        }

        // æ’­æ”¾è²éŸ³ï¼ˆè¿”å› Promiseï¼‰
        function playSound(zhuyin, element) {
            return new Promise((resolve) => {
                if (!zhuyin || zhuyin === '\n') {
                    resolve();
                    return;
                }
                
                // åœæ­¢ä¹‹å‰çš„éŸ³æª”
                if (playingAudio) {
                    playingAudio.pause();
                    playingAudio = null;
                }
                
                // ç§»é™¤æ‰€æœ‰æ’­æ”¾ä¸­çš„æ¨£å¼
                document.querySelectorAll('.text-cell.playing').forEach(cell => {
                    cell.classList.remove('playing');
                });
                
                // æ·»åŠ æ’­æ”¾æ¨£å¼
                if (element) {
                    element.classList.add('playing');
                }
                
                // å»ºç«‹éŸ³æª”è·¯å¾‘
                const soundFile = soundBasePath + zhuyin + '.mp3';
                console.log('æ’­æ”¾:', soundFile);
                
                const audio = new Audio(soundFile);
                playingAudio = audio;
                
                // è¨­å®šçµæŸäº‹ä»¶
                audio.onended = () => {
                    if (element) {
                        element.classList.remove('playing');
                    }
                    playingAudio = null;
                    resolve();
                };
                
                // è¨­å®šéŒ¯èª¤è™•ç†
                audio.onerror = () => {
                    console.error(`ç„¡æ³•æ’­æ”¾éŸ³æª”: ${soundFile}`);
                    if (element) {
                        element.classList.remove('playing');
                    }
                    playingAudio = null;
                    
                    // å°æ–¼è¼•è²ç¬¦è™Ÿï¼Œä¸ä½¿ç”¨èªéŸ³åˆæˆ
                    if (zhuyin.includes('Ë™')) {
                        console.log('è¼•è²ç¬¦è™Ÿï¼Œè·³éèªéŸ³åˆæˆ');
                        resolve();
                        return;
                    }
                    
                    // ä½¿ç”¨èªéŸ³åˆæˆä½œç‚ºå‚™ç”¨æ–¹æ¡ˆ
                    try {
                        const utterance = new SpeechSynthesisUtterance(zhuyin);
                        utterance.lang = 'zh-TW';
                        utterance.rate = 0.8;
                        
                        utterance.onend = () => {
                            if (element) {
                                element.classList.remove('playing');
                            }
                            resolve();
                        };
                        
                        speechSynthesis.speak(utterance);
                    } catch (e) {
                        console.error('èªéŸ³åˆæˆä¹Ÿå¤±æ•—:', e);
                        resolve();
                    }
                };
                
                // å˜—è©¦æ’­æ”¾
                audio.play().catch(error => {
                    console.error('æ’­æ”¾éŒ¯èª¤:', error);
                    if (element) {
                        element.classList.remove('playing');
                    }
                    resolve();
                });
            });
        }

        // å…¨æ–‡å¿µè®€ï¼ˆèª¿æ•´åœé “æ™‚é–“æ›´è‡ªç„¶ï¼‰
        async function playAll() {
            if (isPlaying) {
                stopPlaying();
                return;
            }
            
            isPlaying = true;
            document.getElementById('playAllBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-block';
            
            // è¨ˆç®—ç•¶å‰é é¢çš„è³‡æ–™ç¯„åœ
            const itemsPerPage = 70;
            const startIndex = currentPage * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, currentData.length);
            
            // å–å¾—ç•¶å‰é é¢çš„å¯¦éš›è³‡æ–™ï¼ˆä¸åŒ…å«æ›è¡Œå’Œç©ºæ ¼ï¼‰
            const pageData = [];
            const cells = document.querySelectorAll('.text-cell:not(.empty)');
            let cellIndex = 0;
            
            for (let i = startIndex; i < endIndex && i < currentData.length; i++) {
                if (!currentData[i].isNewline && !currentData[i].isEmpty) {
                    pageData.push({
                        data: currentData[i],
                        cell: cells[cellIndex]
                    });
                    cellIndex++;
                }
            }
            
            // ä¾åºæ’­æ”¾æ¯å€‹å­—
            for (let i = 0; i < pageData.length; i++) {
                if (!isPlaying) break;
                
                const { data, cell } = pageData[i];
                
                if (!data || !data.zhuyin || data.zhuyin === '\n') continue;
                
                // ç­‰å¾…éŸ³æª”æ’­æ”¾å®Œæˆ
                await playSound(data.zhuyin, cell);
                
                // æ›´è‡ªç„¶çš„åœé “æ™‚é–“
                if (!isPlaying) break;
                
                let extraDelay = 50; // é è¨­æ¥µçŸ­åœé “
                
                // æ ¹æ“šæ¨™é»ç¬¦è™Ÿèª¿æ•´åœé “
                if (data.char === 'ã€‚' || data.char === 'ï¼' || data.char === 'ï¼Ÿ') {
                    extraDelay = 400; // å¥è™Ÿåœé “
                } else if (data.char === 'ï¼Œ' || data.char === 'ï¼›') {
                    extraDelay = 200; // é€—è™Ÿåœé “
                } else if (data.char === 'ã€') {
                    extraDelay = 100; // é “è™Ÿåœé “
                }
                
                // ç­‰å¾…é¡å¤–åœé “æ™‚é–“
                if (extraDelay > 0) {
                    await new Promise(resolve => setTimeout(resolve, extraDelay));
                }
            }
            
            stopPlaying();
        }

        // åœæ­¢æ’­æ”¾
        function stopPlaying() {
            isPlaying = false;
            
            if (playingAudio) {
                playingAudio.pause();
                playingAudio = null;
            }
            
            // åœæ­¢èªéŸ³åˆæˆ
            speechSynthesis.cancel();
            
            // é‡è¨­æŒ‰éˆ•
            document.getElementById('playAllBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').style.display = 'none';
            
            // ç§»é™¤æ‰€æœ‰æ’­æ”¾æ¨£å¼
            document.querySelectorAll('.text-cell.playing').forEach(cell => {
                cell.classList.remove('playing');
            });
        }

        // è¨­å®šé¡¯ç¤ºæ¨¡å¼
        function setDisplayMode(mode) {
            displayMode = mode;
            
            document.querySelectorAll('.control-group:first-child .control-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (mode === 'char') {
                event.target.classList.add('active');
            } else if (mode === 'both') {
                document.querySelectorAll('.control-group:first-child .control-button')[1].classList.add('active');
            } else {
                document.querySelectorAll('.control-group:first-child .control-button')[2].classList.add('active');
            }
            
            renderPage();
        }

        // æ›´æ›å­—å‹
        function changeFont() {
            currentFont = document.getElementById('fontSelector').value;
            document.querySelectorAll('.main-char').forEach(elem => {
                elem.style.fontFamily = currentFont;
            });
        }

        // ä¸Šä¸€é 
        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                stopPlaying();
                renderPage();
            }
        }

        // ä¸‹ä¸€é 
        function nextPage() {
            if (currentPage < totalPages - 1) {
                currentPage++;
                stopPlaying();
                renderPage();
            }
        }

        // æ›´æ–°é é¢è³‡è¨Š
        function updatePageInfo() {
            document.getElementById('pageInfo').textContent = 
                `ç¬¬ ${currentPage + 1} é  / å…± ${totalPages} é `;
            
            document.querySelector('.pagination button:first-child').disabled = currentPage === 0;
            document.querySelector('.pagination button:last-child').disabled = currentPage === totalPages - 1;
        }

        // è¿”å›é¸æ“‡ç•«é¢
        function backToSelection() {
            stopPlaying();
            
            document.getElementById('selectionScreen').style.display = 'block';
            document.getElementById('mainInterface').style.display = 'none';
            document.querySelector('.back-button').style.display = 'none';
            
            // é‡è¨­ç‹€æ…‹
            currentPage = 0;
            isPlaying = false;
        }

        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showStatus(message) {
            const status = document.getElementById('statusMessage');
            status.textContent = message;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', (e) => {
            if (document.getElementById('mainInterface').style.display === 'block') {
                if (e.key === 'ArrowLeft') {
                    previousPage();
                } else if (e.key === 'ArrowRight') {
                    nextPage();
                } else if (e.key === ' ') {
                    e.preventDefault();
                    playAll();
                } else if (e.key === 'Escape') {
                    stopPlaying();
                }
            }
        });

        // é é¢è¼‰å…¥æç¤º
        console.log('=== èª²æ–‡æœ—è®€ç³»çµ± ===');
        console.log('DATA è³‡æ–™å¤¾çµæ§‹:');
        console.log('DATA/');
        console.log('â”œâ”€â”€ è¼¸æ—åœ‹èªä¸€ä¸Š/');
        console.log('â”‚   â”œâ”€â”€ ç¬¬ä¸€èª².txt');
        console.log('â”‚   â””â”€â”€ ...');
        console.log('â”œâ”€â”€ è¼¸æ—åœ‹èªä¸€ä¸‹/');
        console.log('â””â”€â”€ ...');
        console.log('');
        console.log('éŸ³æª”è·¯å¾‘:', soundBasePath);
        console.log('è¼•è²éŸ³æª”: ã„‰ã„œË™.mp3, ã„‡ã„šË™.mp3');
    </script>
</body>
</html>
